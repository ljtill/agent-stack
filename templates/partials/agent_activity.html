{% macro _run_summary(run, link) %}
{%- if link -%}
    {%- set domain = link.url.split('/')[2] if link.url and '/' in link.url else link.url -%}
    {%- if run.stage == 'fetch' -%}
        Fetching content from {{ domain }}
    {%- elif run.stage == 'review' -%}
        Reviewing {{ link.title or domain }}
    {%- elif run.stage == 'draft' -%}
        Drafting content for {{ link.title or domain }}
    {%- else -%}
        Processing {{ link.title or domain }}
    {%- endif -%}
{%- elif run.stage == 'edit' -%}
    Editing edition from feedback
{%- elif run.stage == 'publish' -%}
    Publishing edition
{%- else -%}
    {{ run.stage | capitalize }} stage
{%- endif -%}
{% endmacro %}

{% macro render_run(run, links_by_id=None) %}
{% set link = links_by_id.get(run.trigger_id) if links_by_id else None %}
<li class="activity-item" id="run-{{ run.id }}">
    <div class="activity-icon activity-icon-{{ run.status }}">
        {% if run.status == 'running' %}
        <span class="spinner">⟳</span>
        {% elif run.status == 'completed' %}
        ✓
        {% else %}
        ✗
        {% endif %}
    </div>
    <div class="activity-body">
        <div class="activity-header">
            <span class="activity-stage stage-{{ run.stage }}">{{ run.stage }}</span>
            <span class="badge badge-{{ run.status }}">{{ run.status }}</span>
            <span class="activity-time">
                {% if run.started_at %}
                {{ run.started_at.strftime('%H:%M:%S') if run.started_at.strftime is defined else run.started_at }}
                {% endif %}
                {% if run.completed_at and run.started_at %}
                · {{ ((run.completed_at - run.started_at).total_seconds() | round(1)) if run.completed_at is not string else '' }}s
                {% endif %}
            </span>
        </div>
        <div class="activity-summary">{{ _run_summary(run, link) }}</div>
        {% if run.status == 'failed' and run.output %}
        <div class="activity-error">{{ run.output.get('error', 'Unknown error') if run.output is mapping else run.output }}</div>
        {% endif %}
        {% if run.output and run.status == 'completed' %}
        <details>
            <summary class="activity-output-toggle">View output</summary>
            <div class="activity-output">{{ run.output | tojson(indent=2) }}</div>
        </details>
        {% endif %}
    </div>
</li>
{% endmacro %}

{% macro render_activity_list(runs, links_by_id=None, sse_enabled=false) %}
<ul class="activity-list"
    {% if sse_enabled %}
    hx-ext="sse" sse-connect="/events"
    {% endif %}
    id="activity-feed">
    {% if runs %}
        {% for run in runs %}
        {{ render_run(run, links_by_id) }}
        {% endfor %}
    {% else %}
    <li class="activity-empty">No agent activity yet.</li>
    {% endif %}
</ul>
{% endmacro %}
